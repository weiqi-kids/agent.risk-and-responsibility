name: Check Links

on:
  schedule:
    - cron: '0 8 * * 1'  # æ¯é€±ä¸€ UTC 08:00
  workflow_dispatch:
  push:
    paths:
      - 'docs/**/*.md'
      - 'index.md'

jobs:
  check-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Build Jekyll site
        run: |
          bundle install
          bundle exec jekyll build

      - name: Check links with lychee
        id: lychee
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --verbose
            --no-progress
            --accept 200,204,206,301,302,303,307,308
            --exclude-mail
            --exclude '^https://github.com/weiqi-kids/agent.risk-and-responsibility'
            --exclude 'localhost'
            --exclude '127.0.0.1'
            --timeout 30
            --max-retries 3
            --retry-wait-time 5
            './_site/**/*.html'
          output: ./lychee-report.md
          fail: false

      - name: Read lychee report
        id: report
        run: |
          if [ -f ./lychee-report.md ]; then
            # Count broken links
            BROKEN=$(grep -c '^\[' ./lychee-report.md 2>/dev/null || echo "0")
            echo "broken_count=$BROKEN" >> $GITHUB_OUTPUT

            # Extract broken URLs
            grep -oE 'https?://[^\s\)]+' ./lychee-report.md | sort -u > broken-urls.txt || true

            echo "Broken links found: $BROKEN"
            cat ./lychee-report.md
          else
            echo "broken_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Attempt auto-fix
        if: steps.report.outputs.broken_count != '0'
        id: autofix
        run: |
          echo "Attempting to fix broken links..."

          FIXES_MADE=0
          FIXES_LOG=""

          # Read broken URLs and attempt fixes
          while IFS= read -r url; do
            [ -z "$url" ] && continue

            echo "Checking: $url"

            # Strategy 1: EUR-Lex /AUTO/ â†’ /EN/TXT/
            if [[ "$url" == *"eur-lex.europa.eu"*"/AUTO/"* ]]; then
              NEW_URL="${url/\/AUTO\//\/EN\/TXT\/}"
              echo "  Trying EUR-Lex fix: $NEW_URL"

              if curl -sL -o /dev/null -w "%{http_code}" "$NEW_URL" | grep -q "200"; then
                echo "  âœ“ Fix works!"

                # Find and replace in source files
                grep -rl "$url" docs/ 2>/dev/null | while read -r file; do
                  sed -i "s|$url|$NEW_URL|g" "$file"
                  echo "  Updated: $file"
                  FIXES_LOG="${FIXES_LOG}\n- \`$file\`: $url â†’ $NEW_URL"
                done

                FIXES_MADE=$((FIXES_MADE + 1))
              fi
            fi

            # Strategy 2: Follow redirects
            FINAL_URL=$(curl -sL -o /dev/null -w "%{url_effective}" "$url" 2>/dev/null || echo "")
            if [ -n "$FINAL_URL" ] && [ "$FINAL_URL" != "$url" ]; then
              HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "$FINAL_URL" 2>/dev/null || echo "0")
              if [ "$HTTP_CODE" = "200" ]; then
                echo "  âœ“ Redirect found: $FINAL_URL"

                grep -rl "$url" docs/ 2>/dev/null | while read -r file; do
                  sed -i "s|$url|$FINAL_URL|g" "$file"
                  echo "  Updated: $file"
                  FIXES_LOG="${FIXES_LOG}\n- \`$file\`: $url â†’ $FINAL_URL"
                done

                FIXES_MADE=$((FIXES_MADE + 1))
              fi
            fi

          done < broken-urls.txt

          echo "fixes_made=$FIXES_MADE" >> $GITHUB_OUTPUT
          echo -e "$FIXES_LOG" > fixes-log.txt

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --stat
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: auto-fix broken links"
          title: "ðŸ”— Auto-fix broken links"
          body: |
            ## Summary

            This PR was automatically generated by the link checker workflow.

            ### Fixes Applied

            $(cat fixes-log.txt 2>/dev/null || echo "See commit diff for details")

            ### Verification

            Please verify the fixes are correct before merging.

            ---
            ðŸ¤– Generated by [Check Links](.github/workflows/check-links.yml) workflow
          branch: fix/broken-links
          delete-branch: true
          labels: |
            automated
            maintenance

      - name: Create Issue for unfixable links
        if: steps.report.outputs.broken_count != '0' && steps.changes.outputs.has_changes == 'false'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸ”— Broken links detected"
          content-filepath: ./lychee-report.md
          labels: |
            bug
            maintenance

      - name: Summary
        run: |
          echo "## Link Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f ./lychee-report.md ]; then
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            cat ./lychee-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All links are valid!" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Auto-fixes Applied" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with automatic fixes." >> $GITHUB_STEP_SUMMARY
          fi
